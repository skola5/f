<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vipan Jumper</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --accent: #22d3ee;
      --muted: #94a3b8;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
      background: radial-gradient(1200px 600px at 50% -200px, #1e293b, var(--bg));
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 16px;
    }

    .wrap { width: min(1200px, 100%); }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 18px;
    }

    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
    header h1 { font-size: clamp(18px, 2.6vw, 28px); margin: 0; letter-spacing: .3px; }

    .meta { display: flex; align-items: center; gap: 16px; font-size: 14px; color: var(--muted); }

    .board { position: relative; background: #0b1220; border-radius: 16px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); }
    canvas { display: block; width: 100%; height: auto; }

    .overlay { position: absolute; inset: 0; display: grid; place-items: center; text-align: center; padding: 20px; background: linear-gradient(180deg, rgba(2,6,23,0.0), rgba(2,6,23,0.42)); }
    .overlay.hidden { display: none; }

    .overlay h2 { margin: 0 0 8px; font-size: clamp(20px, 3vw, 36px); }
    .overlay p { margin: 6px 0; color: var(--muted); }

    .btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px; }
    button {
      background: var(--panel); color: var(--text); border: 1px solid rgba(255,255,255,0.14); border-radius: 12px;
      padding: 10px 14px; font-size: 14px; cursor: pointer; transition: transform .08s ease, box-shadow .2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.35); }

    #startMenu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .character-select {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .character-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px;
      cursor: pointer;
    }
    .character-option img {
      width: 120px;
      height: 120px;
      border: 2px solid #333;
      border-radius: 12px;
    }
    .character-option span {
      margin-top: 8px;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="wrap card">
    <header>
      <h1>Vipan Jumper</h1>
      <div class="meta"></div>
    </header>

    <div class="board" id="board">
      <div id="startMenu">
        <h2 style="color: #ff0000;">Välj din karaktär</h2>
        <div class="character-select" id="characterSelect"></div>
      </div>
      <canvas id="game" width="1200" height="500" aria-label="Dino Jumper spelbräde"></canvas>
      <div class="overlay" id="overlay">
        <div>
          <h2 style="color:white;">Tryck för att starta</h2>
          <p style="color: #0000ff;">
            <strong style="color:white;">Mellanslag</strong> <strong style="color:white;">↑</strong> <strong style="color:white;">W</strong> <strong style="color:white;">eller<strong></strong> <strong style="color:white;">Tryck/Touch</strong>
          </p>
          <div class="btns"><button id="startBtn">Starta</button></div>
        </div>
      </div>
    </div>

 <script>
  const CONFIG = {
    gravity: 2100,
    jumpVelocity: 920,
    initialSpeed: 380,
    speedRamp: 0.02, // långsammare speed ramp
    spawnEveryMin: 1.2,
    spawnEveryMax: 1.8,
    groundHeight: 80,
    dinoDisplaySize: { w: 120, h: 120 },
    maxLives: 1,
    hitboxShrink: 0.85
  };

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const board = document.getElementById('board');
  const startMenu = document.getElementById('startMenu');
  const characterSelect = document.getElementById('characterSelect');

  let dinoSkins = [];
  let itemSkins = [];
  let jumpSounds = [];
  let images = { cig: null, bak: null };
  let selectedDino = null;
  let selectedItem = null;
  let selectedSound = null;
  let items = [];
  let collected = 0;

  // Nya ljud
  let pickupSound = null;
  let lobbyMusic = null;
  let gameMusic = null;

  const state = {
    started: false,
    gameOver: false,
    time: 0,
    speed: CONFIG.initialSpeed,
    score: 0,
    high: 0,
    dino: { x: 60, y: 0, vy: 0, onGround: true },
    obstacles: [],
    spawnTimer: 0,
    nextSpawnIn: 1.2,
  };

  const characters = [
    { file: "dino.png", name: "Martin Borg", color: "blue", item: "item.png", jump: "jump.mp3" },
    { file: "dino2.png", name: "Elisabeth Lindskoug", color: "darkgreen", item: "item2.png", jump: "jump2.mp3" },
    { file: "dino3.png", name: "Jens Carlström", color: "red", item: "item3.png", jump: "jump3.mp3" },
    { file: "dino4.png", name: "Thor Sörensen", color: "purple", item: "item4.png", jump: "jump4.mp3" }
  ];

  function chooseCharacter(index) {
    selectedDino = dinoSkins[index];
    selectedItem = itemSkins[index];
    selectedSound = jumpSounds[index];
    startMenu.style.display = 'none';
    lobbyMusic.pause();
    lobbyMusic.currentTime = 0;
  }

  function rand(min, max) { return Math.random() * (max - min) + min; }
  function rectsCollide(a, b) { return (a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y); }
  function scaledHitbox(x, y, w, h, scale) { const dw=w*scale, dh=h*scale; return { x: x+(w-dw)/2, y: y+(h-dh)/2, w: dw, h: dh }; }
  function formatScore(n) { return String(Math.floor(n)).padStart(5, '0'); }

  function loadImage(src) { return new Promise((resolve, reject) => { const img=new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src=src; }); }
  function loadSound(src, loop=false) {
    return new Promise((resolve, reject) => {
      const audio=new Audio(src);
      audio.loop = loop;
      audio.oncanplaythrough=()=>resolve(audio);
      audio.onerror=reject;
    });
  }

  async function preload() {
    dinoSkins = await Promise.all(characters.map(c => loadImage(c.file)));
    itemSkins = await Promise.all(characters.map(c => loadImage(c.item)));
    jumpSounds = await Promise.all(characters.map(c => loadSound(c.jump)));
    const [cig, bak] = await Promise.all([loadImage('cig.png'), loadImage('bak.png')]);
    images.cig = cig;
    images.bak = bak;

    // Ladda nya ljud
    pickupSound = await loadSound("itempickup.mp3");
    lobbyMusic = await loadSound("lobbymusic.mp3", true);
    gameMusic = await loadSound("soundtrack.mp3", true);

    // Starta lobby-musiken
    lobbyMusic.play();

    characters.forEach((c, i) => {
      const div = document.createElement("div");
      div.className = "character-option";
      div.innerHTML = `<img src="${c.file}" alt="${c.name}"><span style="color:${c.color};">${c.name}</span>`;
      div.onclick = () => chooseCharacter(i);
      characterSelect.appendChild(div);
    });
  }

  function reset() {
    state.started = false; state.gameOver = false; state.time = 0; state.speed = CONFIG.initialSpeed; state.score = 0;
    state.obstacles = []; state.spawnTimer = 0; state.nextSpawnIn = rand(CONFIG.spawnEveryMin, CONFIG.spawnEveryMax);
    items = []; collected = 0;
    const groundY = canvas.height - CONFIG.groundHeight;
    state.dino.y = groundY - CONFIG.dinoDisplaySize.h;
    state.dino.vy = 0; state.dino.onGround = true;
    overlay.classList.remove('hidden'); overlay.querySelector('h2').textContent = 'Tryck för att starta';
    gameMusic.pause();
    gameMusic.currentTime = 0;
    lobbyMusic.play();
  }

  function startGame() {
    if (!images.cig || !images.bak || !selectedDino || !selectedItem || !selectedSound) return;
    overlay.classList.add('hidden');
    state.started = true;
    state.gameOver = false;
    lastTime = performance.now();
    lobbyMusic.pause();
    gameMusic.play();
    requestAnimationFrame(loop);
  }

  function gameOver() {
    state.gameOver = true; state.started = false;
    state.high = Math.max(state.high, Math.floor(state.score));
    overlay.classList.remove('hidden');
    overlay.querySelector('h2').textContent = 'Game Over';
    overlay.querySelector('p').innerHTML = "Poäng: <strong style="color:white;">${Math.floor(state.score)}</strong> · "Bästa: <strongstyle="color:white;">${state.high}</strong> · "Saker: <strongstyle="color:white;">${collected}</strong>`;
    gameMusic.pause();
    gameMusic.currentTime = 0;
    lobbyMusic.play();
  }

  function tryJump() { 
    if (state.gameOver) return; 
    if (state.dino.onGround) { 
      state.dino.vy = -CONFIG.jumpVelocity; 
      state.dino.onGround = false; 
      if (selectedSound) { 
        selectedSound.currentTime = 0; 
        selectedSound.play(); 
      }
    } 
  }

  window.addEventListener('keydown', (e) => { 
    if (['Space','ArrowUp','KeyW'].includes(e.code)) { 
      e.preventDefault(); 
      if (startMenu.style.display !== 'none') return;
      if (!state.started) startGame(); 
      tryJump(); 
    } 
    if (e.code==='Enter'&&state.gameOver) reset(); 
  });
  board.addEventListener('pointerdown', () => { 
    if (startMenu.style.display !== 'none') return;
    if (!state.started) startGame(); 
    tryJump(); 
  });
  startBtn.addEventListener('click', () => { if (state.gameOver) reset(); startGame(); });

  let lastTime = 0;
  function loop(now) { const dt=Math.min(0.032,(now-lastTime)/1000); lastTime=now; update(dt); render(); if(state.started) requestAnimationFrame(loop); }

  function update(dt) {
    state.speed *= (1 + CONFIG.speedRamp * dt);
    state.score += state.speed * dt * 0.05;
    const groundY = canvas.height - CONFIG.groundHeight;
    state.dino.vy += CONFIG.gravity * dt;
    state.dino.y += state.dino.vy * dt;
    if (state.dino.y + CONFIG.dinoDisplaySize.h >= groundY) { state.dino.y = groundY - CONFIG.dinoDisplaySize.h; state.dino.vy = 0; state.dino.onGround = true; }

    state.spawnTimer += dt;
    if (state.spawnTimer >= state.nextSpawnIn) {
      state.spawnTimer = 0; state.nextSpawnIn = rand(CONFIG.spawnEveryMin, CONFIG.spawnEveryMax);
      const baseH = rand(50, 80);
      const ar = images.cig.width / images.cig.height;
      const w = baseH * ar; const h = baseH;
      state.obstacles.push({ x: canvas.width + rand(0,60), y: groundY - h, w, h });
    }

    for (const o of state.obstacles) o.x -= state.speed * dt;
    state.obstacles = state.obstacles.filter(o => o.x + o.w > -10);

    // --- Items ---
    if (Math.random() < 0.002) { 
      const size = 80; // större items
      items.push({ x: canvas.width, y: groundY - size - rand(20,80), w: size, h: size });
    }
    for (const it of items) it.x -= state.speed * dt;
    items = items.filter(it => it.x + it.w > -10);

    const dinoBox = scaledHitbox(state.dino.x, state.dino.y, CONFIG.dinoDisplaySize.w, CONFIG.dinoDisplaySize.h, CONFIG.hitboxShrink);
    for (let i = items.length - 1; i >= 0; i--) {
      const it = items[i];
      const itBox = scaledHitbox(it.x, it.y, it.w, it.h, 0.9);
      if (rectsCollide(dinoBox, itBox)) {
        collected++;
        if (pickupSound) {
          pickupSound.currentTime = 0;
          pickupSound.play();
        }
        items.splice(i, 1);
      }
    }

    for (const o of state.obstacles) {
      const oBox = scaledHitbox(o.x, o.y, o.w, o.h, CONFIG.hitboxShrink);
      if (rectsCollide(dinoBox, oBox)) { gameOver(); break; }
    }
  }

  function render() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(images.bak, 0, 0, canvas.width, canvas.height);
    const groundY = canvas.height - CONFIG.groundHeight; ctx.fillStyle='#0f1b2f'; ctx.fillRect(0,groundY,canvas.width,CONFIG.groundHeight);
    drawParallax(groundY);
    for (const o of state.obstacles) ctx.drawImage(images.cig, o.x, o.y, o.w, o.h);
    for (const it of items) if (selectedItem) ctx.drawImage(selectedItem, it.x, it.y, it.w, it.h);
    if (selectedDino) ctx.drawImage(selectedDino, state.dino.x, state.dino.y, CONFIG.dinoDisplaySize.w, CONFIG.dinoDisplaySize.h);
    ctx.font='bold 20px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas'; ctx.textAlign='left'; ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillText(`POÄNG ${formatScore(state.score)} · Saker ${collected}`,14,28);
    ctx.textAlign='right'; ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fillText(`BÄSTA ${formatScore(state.high)}`,canvas.width-14,28);
    if (state.gameOver) { ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fillRect(canvas.width/2-140,canvas.height/2-40,280,80); ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillText('Tryck ENTER eller klicka för att spela igen',canvas.width/2,canvas.height/2+4); }
  }

  function drawParallax(groundY) {
    const t=state.time;
    const base=state.speed*0.15;
    state.time+=0.016;

    ctx.globalAlpha=0.35;
    for(let i=0;i<40;i++){
      const x=((i*120+(t*base))%(canvas.width+120))-60;
      const y=40+(i*23)%(groundY-80);
      ctx.fillStyle='#a0aec0';
      ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha=1;

    ctx.strokeStyle='#12213a';
    ctx.lineWidth=2;
    ctx.beginPath();
    const h=groundY-18;
    for(let x=0;x<=canvas.width;x+=12){
      const y=h-Math.abs(Math.sin((x+t*40)*0.01))*8-8;
      if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function fitCanvas() {
    const maxW=Math.min(1200,board.clientWidth);
    const aspect=canvas.width/canvas.height;
    canvas.style.width=maxW+'px';
    canvas.style.height=(maxW/aspect)+'px';
  }
  window.addEventListener('resize', fitCanvas);

  (async function boot(){
    try{ await preload(); }
    catch(e){ console.error('Kunde inte ladda bilderna/ljuden.', e); }
    fitCanvas();
    reset();
    render();
  })();
</script>
</body>
</html>
